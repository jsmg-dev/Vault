<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deposit Amount</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(to right, #004aad, #007bff);
    }
    .form-container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    h2 { text-align: center; color: #004aad; margin-bottom: 25px; font-size: 26px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
    select, input {
      width: 100%; padding: 12px; margin-bottom: 20px; font-size: 14px;
      border: 1.5px solid #ccc; border-radius: 8px; background-color: #f9f9f9;
    }
    input:focus, select:focus { border-color: #004aad; outline: none; background-color: #fff; box-shadow: 0 0 4px rgba(0, 74, 173, 0.15); }
    button {
      width: 100%; padding: 14px; background: linear-gradient(to right, #004aad, #007bff);
      color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s;
    }
    button:hover { background: linear-gradient(to right, #00347a, #0055cc); }
    .help { margin-top: -12px; margin-bottom: 16px; font-size: 12px; color: #666; }
    .hint { font-size: 12px; color: #c0392b; margin-top: -10px; margin-bottom: 10px; display:none; }
    @media (max-width: 600px) { .form-container { padding: 25px; } h2 { font-size: 22px; } }
  </style>
</head>
<body>

<div class="form-container">
  <h2>Deposit Amount</h2>

  <form id="depositForm" autocomplete="off" novalidate>
    <!-- Customer Dropdown -->
    <label for="customer-dropdown">Select Customer</label>
    <select id="customer-dropdown" required></select>
    <div id="load-hint" class="hint">Couldn‚Äôt load customers. Check the /deposits/dropdown/customers API.</div>

    <!-- Auto-filled Customer Code -->
    <label for="customer_code">Customer Code</label>
    <input type="text" id="customer_code" class="form-control" readonly>

    <label for="amount">Deposit Amount</label>
    <input type="number" id="amount" name="amount" placeholder="Enter amount" inputmode="decimal" step="0.01" min="0" required />

    <label for="penalty">Penalty</label>
    <input type="number" id="penalty" name="penalty" placeholder="Enter penalty (optional)" inputmode="decimal" step="0.01" min="0" />

    <label for="date">Date</label>
    <input type="text" id="date" name="date" placeholder="MM/DD/YYYY" required />
    <div class="help">Format: MM/DD/YYYY (e.g., 07/15/2025)</div>

    <button id="submitBtn" type="submit">Submit Deposit</button>
  </form>
</div>

<script>
$(function () {
  console.log("üìÑ Deposit form loaded.");

  // --- Datepicker ---
  $("#date").datepicker({ dateFormat: "mm/dd/yy", changeMonth: true, changeYear: true, showAnim: "fadeIn" });

  // Map to reliably fetch code by selected id (works with Select2)
  const codeById = new Map();

  // Helper to update the code field from the selected value
  function updateCustomerCodeField() {
    const dropdown = $('#customer-dropdown');
    const selectedId = dropdown.val(); // string
    const code = codeById.get(String(selectedId)) || '';
    $('#customer_code').val(code);
    console.log("üë§ Customer selected:", { id: selectedId, code: code });
  }

  // --- Load customers into dropdown ---
  async function loadCustomers() {
    const dropdown = $('#customer-dropdown');
    const hint = $('#load-hint');

    dropdown.html('<option value="">Loading...</option>');
    console.log("‚è≥ Fetching customers from /deposits/dropdown/customers...");

    try {
      const res = await fetch('/deposits/dropdown/customers', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const customers = await res.json();

      console.log("‚úÖ Customers loaded:", customers);

      dropdown.html('<option value="">Select Customer</option>');
      codeById.clear();

      customers.forEach(c => {
        codeById.set(String(c.id), c.customer_code || '');
        dropdown.append(`<option value="${c.id}">${c.name}</option>`);
      });

      // Init / re-init Select2
      dropdown.select2({ placeholder: 'Select Customer', width: '100%' });

      dropdown.on('change', updateCustomerCodeField);
      dropdown.on('select2:select', updateCustomerCodeField);

      hint.hide();
    } catch (err) {
      console.error('‚ùå Failed to load customers:', err);
      $('#customer_code').val('');
      codeById.clear();
      dropdown.html('<option value="">-- Failed to load customers --</option>');
      $('#load-hint').show();
    }
  }

  // --- Submit handler ---
  $('#depositForm').on('submit', async function(e) {
    e.preventDefault();

    const $btn = $('#submitBtn');
    $btn.prop('disabled', true).text('Submitting...');

    try {
      const dropdown = $('#customer-dropdown');
      const selectedId = dropdown.val();
      const selectedText = dropdown.find('option:selected').text().trim();
      const customer_name = selectedText || '';
      const customer_code = codeById.get(String(selectedId)) || '';
      const amount = Number($('#amount').val().trim());
      const penaltyRaw = $('#penalty').val().trim();
      const penalty = penaltyRaw === '' ? 0 : Number(penaltyRaw);
      const date = $('#date').val().trim();

      console.log("üì§ Submitting deposit payload:", { customer_name, customer_code, amount, penalty, date });

      if (!selectedId) { alert('‚ùå Please select a customer.'); return; }
      if (!customer_code) { alert('‚ùå Customer code not loaded.'); return; }
      if (!(amount > 0)) { alert('‚ùå Please enter a valid positive amount.'); return; }
      if (!(penalty >= 0)) { alert('‚ùå Penalty must be zero or positive.'); return; }
      if (!date) { alert('‚ùå Please enter a valid date.'); return; }

      const payload = { customer_name, customer_code, amount, penalty, date };

      const res = await fetch('/deposits/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json().catch(() => ({}));
      if (res.ok) {
        console.log("‚úÖ Deposit submitted successfully:", result);
        alert('‚úÖ Deposit submitted successfully');
        window.location.href = '/pages/deposit-list.html';
      } else {
        console.error("‚ùå Deposit submission failed:", result);
        alert('‚ùå ' + (result.error || `Failed (HTTP ${res.status})`));
      }
    } catch (err) {
      console.error('‚ùå Submit error:', err);
      alert('‚ùå Error submitting deposit.');
    } finally {
      $btn.prop('disabled', false).text('Submit Deposit');
    }
  });

  loadCustomers();
});
</script>

</body>
</html>
